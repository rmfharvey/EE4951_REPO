/*
 * DutISense.h
 *
 *  Created on: Nov 28, 2015
 *      Author: RossHarvey
 */

#ifndef SOURCES_DUTISENSE_H_
#define SOURCES_DUTISENSE_H_

#include <assert.h>
#include <stdint.h>
#include "dut_gpio.h"
#include "dut_adc.h"

#define NUMRANGES	4U
//#define VREF	3.0F

/****************************************************************************************************
 * This struct holds all values relevant to the individual current ranges in the project			*
 * The raw and scaled ADC values will probably never be used here/ but I've included them 			*
 * 		just in case we want to.																	*
 ****************************************************************************************************/
typedef struct CURRENT_RANGE	{
	uint32_t 			enPinName;			// Enable pin for each current range
	adc16_chn_config_t	adcChConfig;		// ADC channel configuration
	volatile uint16_t 	rawADCVal;			// 16-bit, unsigned fractional ADC value
	float				scaledADCVal;		// ADC Val scaled by reference voltage
	float				shuntRes;			// Current shunt resistance value
	uint8_t				ampGain;			// Shunt amplifier gain
	float				scalingFactor;		// Scaling factor
}currentRange_t;


/****************************************************************************************************
 * This class should handle all DUT I-sense related calls											*
 ****************************************************************************************************/
class DutISense {
public:
	DutISense();							// Constructor auto-initializes all DUT Isense channels
	virtual ~DutISense();					// Destructor doesn't do anything right now
	void setCurrentRange(uint8_t range);	// Sets which range is active
	uint8_t getCurrentRange(void);			// Returns the active range as an unsigned int in [0,3]
	uint16_t getADCValRaw();
private:
	uint8_t numCurrentRanges;
	currentRange_t range0;
	currentRange_t range1;
	currentRange_t range2;
	currentRange_t range3;
	currentRange_t *activeRange;	// Pointer to whichever range is currently active

	void PRV_setCurrentRangeValues(currentRange_t *cRange, uint32_t pinName, adc16_chn_config_t cfg, float shRes, uint8_t gain);
	void PRV_enableRange(currentRange_t *newRange);
};

#endif /* SOURCES_DUTISENSE_H_ */
